#
#       .github/workflows/ContinuousTesting-Linux.yml
#
#       Copyright (C) 2014 - 2021  The CFS SW Platform Development Team.
#                        All rights reserved.
#
#
#    Permission is hereby granted, free of charge, to any person obtaining
#    a copy of this software and associated documentation files (the
#    "Software"), to deal in the Software without restriction, including
#    without limitation the rights to use, copy, modify, merge, publish,
#    distribute, sublicense, and/or sell copies of the Software, and to
#    permit persons to whom the Software is furnished to do so, subject to
#    the following conditions:
#
#    The above copyright notice and this permission notice shall be
#    included in all copies or substantial portions of the Software.
#
#    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
#    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
#    MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
#    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
#    LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
#    OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
#    WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#
#

# GitHub Actions workflow file
# https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions

name: ðŸ§ðŸ§ Continuous Integration

# GitHub Actions workflow file
# https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions

    # group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
    # group: ci-${{ github.event.pull_request.number || github.ref }}
    # group: "workflow = ${{ github.workflow }}, ref = ${{ github.event.ref }}, pr = ${{ github.event.pull_request.id }}"
    # cancel-in-progress: ${{ github.event_name == 'pull_request' || github.repository != 'doevelopper/rules-infra' }}
    # group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
concurrency:
    # Cancel previous actions from the same PR: https://stackoverflow.com/a/72408109
    group: ci-${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main, master, develop, feature/**, bugfix/**, hotfix/**, support/**, defects/** ]
    paths-ignore:
      - '**.md'
      - 'src/main/resources/**'
      - 'src/test/resources/**'
      - 'src/site/**'
    # - '.github/workflows/**'
    # tags: [ 'rev-*.*.*' ] # Workflow run on tags for vx.x.x only.
    # branches-ignore: [ incubator/**]
    tags-ignore:
      - 'rev-0*.*.*'
  pull_request:
    branches: [ main, master, develop, feature/**, bugfix/**, hotfix/**, support/**, defects/** ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:


jobs:
  # matrix-prep-* steps generate JSON used to create a dynamic actions matrix.
  # Insanely complex for how simple this requirement is inspired from
  # https://stackoverflow.com/questions/65384420/how-to-make-a-github-action-matrix-element-conditional

  Build-test-and-package:
    name: >
      ${{ github.actor }} Compile, link, test and produce ${{ github.repository }} 's artifacts on ${{ matrix.host_os }} with ${{ matrix.compiler }}.
    continue-on-error: ${{ matrix.ignore-errors }}
    timeout-minutes: 10
    env:
      CC: ${{matrix.cc}}
      CXX: ${{matrix.cxx}}
      LD: ${{matrix.ld}}
    strategy:
      fail-fast: false # Keep running other jobs even if one fails
      bazel_compilation_mode: ["fastbuild", "dbg" , "opt"]
      matrix:
        path:
          - check: 'src'
            exclude: '(hello|world)' # Exclude file paths containing "hello" or "world"
          - check: 'examples'
            exclude: ''              # Nothing to exclude
        include:
          - host_os: ubuntu-22.04
            compiler: clang
            compiler-version: 14
            ignore-errors: false
            cc: clang
            cxx: clang++
            ld: ld
            bazelisk: "1.16.0"
          - host_os: ubuntu-22.04
            compiler: gcc
            compiler-version: 12
            ignore-errors: false
            cc: gcc
            cxx: g++
            ld: ld
            bazelisk: "1.16.0"

        # host_os: [ubuntu-22.04, ubuntu-20.04]
        # # target_os: [linux, ios, android, windows, arm64v8l]
        # jdk: [8, 11, 14]
        # bazelisk: [1.16.0]
    runs-on: ${{ matrix.host_os }}
    env:
      JDK_VERSION:  ${{ matrix.jdk }}

    name: Java ${{ matrix.Java }} sample
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout ${{ github.ref }} ( ${{ github.sha }} )
        # if: ${{ github.event_name != 'pull_request_target' }}
        uses: actions/checkout@v3
        with:
          # Disabling shallow clone is recommended for improving relevancy of reporting
          submodules: 'recursive'
          fetch-depth: 0

      - name: Setup java version ${{ matrix.java }}
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java }}

      - name: Set up Clang
        uses: egor-tensin/setup-clang@v1
        with:
          version: latest
          platform: x64

      - name: Run clang format
        uses: DoozyX/clang-format-lint-action@v0.14
          with:
            source: '.'
            exclude: './src/main/resources ./src/test/resources'
            extensions: 'hpp,cpp'
            clangFormatVersion: 14
            # style: chromium

      - name: Run clang-format style check for C/C++/Protobuf programs.
        uses: jidicula/clang-format-action@v4.10.1
        with:
          clang-format-version: '14'
          check-path: ${{ matrix.path['check'] }}
          exclude-regex: ${{ matrix.path['exclude'] }}
          fallback-style: 'Mozilla' # optional

      - name: setup bazelisk ${{ matrix.bazelisk }}
        uses: bazelbuild/setup-bazelisk@v2
        with:
          bazelisk-version: ${{ matrix.bazelisk }}
      #     ref: ${{ github.event.pull_request.head.sha }}
      # Cache build and external artifacts so that the next ci build is incremental.
      # Because github action caches cannot be updated after a build, we need to
      # store the contents of each build in a unique cache key, then fall back to loading
      # it on the next ci run. We use hashFiles(...) in the key and restore-keys- with
      # the prefix to load the most recent cache for the branch on a cache miss. You
      # should customize the contents of hashFiles to capture any bazel input sources,
      # although this doesn't need to be perfect. If none of the input sources change
      # then a cache hit will load an existing cache and bazel won't have to do any work.
      # In the case of a cache miss, you want the fallback cache to contain most of the
      # previously built artifacts to minimize build time. The more precise you are with
      # hashFiles sources the less work bazel will have to do.
      # ${{ hashFiles('**/BUILD.bazel', '**/*.bzl', 'WORKSPACE') }}
      - name: Mount bazel caches
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazel-repo
            ~/.cache/pip
            ~/vcpkg
            ./build/vcpkg_installed
            ${{ env.HOME }}/.cache/vcpkg/archives
            ${{ env.XDG_CACHE_HOME }}/vcpkg/archives
            ${{ env.LOCALAPPDATA }}\vcpkg\archives
            ${{ env.APPDATA }}\vcpkg\archives
          key: bazel-cache-${{ runner.os }}-${{ hashFiles('WORKSPACE') }}
          restore-keys: |
            bazel-cache-
            bazel-cache-${{ runner.os }}-
  # unit-test:
  #   name: ${{ github.repository }} Unit tests using ${{ matrix.compiler.name }}
  #   needs: []
  #   runs-on: ${{ matrix.config.os }}
  #   # if: github.event.workflow_run.conclusion != 'skipped'
  #   timeout-minutes: 20
  #   strategy:
  #     fail-fast: false
  #     # max-parallel: 1
  #     matrix:
  #       bazel: [6.0.0]
  #       bazelisk: [1.15.0]
  #       # python-version: [3.10]
  #       # compilation_mode: [ fastbuild, dbg, opt]
  #       # shared: [true, false]
  #       folder:
  #         - "."
  #         - "e2e/workspace"
  #       config:
  #         - { name: "Ubuntu", os: ubuntu-latest, target: "linux" }

  #   # Steps represent a sequence of tasks that will be executed as part of the job
  #   steps:
  #     # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
  #     - name: Checkout ${{ github.ref }} ( ${{ github.sha }} )
  #       if: ${{ github.event_name != 'pull_request_target' }}
  #       uses: actions/checkout@v3
  #       with:
  #         # Disabling shallow clone is recommended for improving relevancy of reporting
  #         submodules: 'recursive'
  #         fetch-depth: 0

  #     # - name: Set up Python ${{ matrix.python-version }}
  #     #   uses: actions/setup-python@v2
  #     #   with:
  #     #     python-version: ${{ matrix.python-version }}
  #     #     architecture: x64
  #     #     cache: 'pip'
  #     #     cache-dependency-path: '**/dev-requirements'
  #     # - name: Install dependencies
  #     #   run: |
  #     #     python -m pip install --upgrade pip
  #     #     python -m pip install --upgrade setuptools
  #     #     python -m pip install -e .[dev]
  #     #     python -m pip install tox tox-gh-action pyperf



  #     - name: Display goals of main and test packages.
  #       run: |
  #         ls -laFS ${{ github.workspace }}
  #         bazelisk build  --config linux --nobuild //...
  #         bazelisk query @com.github.doevelopper.rules-infra//...

  #     - name: Compile the main source code
  #       env:
  #         # Bazelisk will download bazel to here, ensure it is cached between runs.
  #         XDG_CACHE_HOME: ~/.cache/bazel-repo
  #       working-directory: ${{ matrix.folder }}
  #       run: bazelisk --bazelrc=$GITHUB_WORKSPACE/.github/workflows/ci.bazelrc --bazelrc=.bazelrc build @com.github.doevelopper.rules-infra//...

  #     - name: Compile the test source code and rune unit tests
  #       env:
  #         # Bazelisk will download bazel to here, ensure it is cached between runs.
  #         XDG_CACHE_HOME: ~/.cache/bazel-repo
  #       working-directory: ${{ matrix.folder }}
  #       run: bazelisk --bazelrc=$GITHUB_WORKSPACE/.github/workflows/ci.bazelrc --bazelrc=.bazelrc test @com.github.doevelopper.rules-infra//...
